#!/usr/bin/env bash
set -euo pipefail

LAYOUT="us"
VARIANT="altgr-intl"

# Decl치ralas como ARRAY (una opci칩n por elemento)
OPTIONS=( "ctrl:swapcaps" "altwin:swap_lalt_lwin" )

# Helpers para formatear opciones
join_by_comma() {
  local IFS=,
  echo "$*"
}
gsettings_list() {
  # imprime "['opt1','opt2']"
  local out="["
  local first=1
  for opt in "$@"; do
    if (( first )); then first=0; else out+=", "; fi
    out+="'$opt'"
  done
  out+="]"
  echo "$out"
}

case "${XDG_SESSION_TYPE:-}" in
  x11)
    setxkbmap -option
    setxkbmap -layout "$LAYOUT" -variant "$VARIANT" -option "$(join_by_comma "${OPTIONS[@]}")"
    ;;
  wayland)
    if printf '%s' "${XDG_CURRENT_DESKTOP:-}${XDG_SESSION_DESKTOP:-}" | grep -qi gnome; then
      gsettings set org.gnome.desktop.input-sources sources "[('xkb','${LAYOUT}+${VARIANT}')]"
      gsettings set org.gnome.desktop.input-sources xkb-options "$(gsettings_list "${OPTIONS[@]}")"
      # En GNOME puede que tengas que reabrir sesi칩n o reiniciar gsd-keyboard:
      # systemctl --user restart org.gnome.SettingsDaemon.Keyboard.service
    else
      echo "Wayland (no GNOME) detectado."
      echo "Configura el keymap en tu compositor (sway/Hyprland) o usa el default del sistema:"
      sudo localectl set-x11-keymap "$LAYOUT" "" "$VARIANT" "$(join_by_comma "${OPTIONS[@]}")"
    fi
    ;;
  *)
    echo "Tipo de sesi칩n desconocido; aplicando defaults X11/TTY."
    sudo localectl set-x11-keymap "$LAYOUT" "" "$VARIANT" "$(join_by_comma "${OPTIONS[@]}")"
    ;;
esac

